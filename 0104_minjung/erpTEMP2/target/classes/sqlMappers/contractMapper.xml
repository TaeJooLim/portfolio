<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="contract">
	
	<sql id="searchCondition">
		<choose>
			<when test="words ==''"></when>
			<when test = "searchOpt == 'all'">
				WHERE cont_doc_num LIKE CONCAT('%', #{words}, '%') 
				OR cont_emp_name LIKE CONCAT('%', #{words}, '%')  
				OR cont_client_company LIKE CONCAT('%', #{words}, '%')  
			</when>
			<otherwise> 
				WHERE ${searchOpt} LIKE CONCAT('%', #{words}, '%')
			</otherwise>
		</choose>
	</sql>
	<select id="getClient" resultType="clientvo">
		SELECT 
			client_company 				AS clientCompany,
			client_license_num 			AS clientLicenseNumFk,
			client_ceo_name				AS contClientCeoName,
			client_company_phone 		AS contClientResCp,			
			client_res_cp 				AS clientResCp,
			client_res_email 			AS contClientResEmail		
		FROM client 
	</select>

	<insert id="setContract" parameterType="contractvo">
		INSERT INTO contract SET 
			cont_doc_num = #{contDocNum},
			cont_com_name = #{contComName},
			cont_emp_company = #{contEmpCompany},
			cont_depart_name = #{contDepartName},
			cont_position_name = #{contPositionName},
			cont_emp_name = #{contEmpName},
			cont_client_company = #{contClientCompany},
			cont_client_ceo_name = #{contClientCeoName},
			cont_client_responsibility 	= #{contClientResponsibility},
			cont_client_res_cp 	= #{contClientResCp},
			cont_client_res_email = #{contClientResEmail},
			cont_orderDate 	= #{contOrderDate},
			cont_dueDate = #{contDueDate},
			cont_note = #{contNote},
			client_license_num_fk = #{clientLicenseNumFk}
	</insert>
	
	<select id="getID" resultType="int" parameterType="String">
		SELECT 
		MAX(cont_id) AS contID FROM contract WHERE client_license_num_fk = #{clientLicenseNumFk}
	</select>
	
	<select id="getCode" resultType="String" parameterType= "hashmap">
		SELECT client_code AS ClientCode FROM contract 
		LEFT JOIN client ON #{clientLicenseNumFk} = client_license_num 
		WHERE cont_id = #{contID}
	</select>
	
	<update id="setContDocNum" parameterType="hashmap">
		UPDATE contract SET 
		cont_doc_num = #{contDocNum} 
		WHERE cont_id = #{contID}
	</update>
	
	<select id ="getproduct" resultType="contractvo" parameterType="hashmap">
		SELECT 
		p_name AS contDpName,
		p_unit AS contDpUnit,
		p_sell AS contDpSell,
		p_buy AS pBuy 
		FROM product WHERE p_name = #{contDpName}
	</select>
	
	
	<select id="getcontlist" resultType="contractvo" parameterType="hashmap">
		SELECT
		cont_id AS contID,
		cont_doc_num AS contDocNum,
		cont_com_name AS contComName,
		cont_emp_company AS contEmpCompany,
		cont_depart_name AS contDepartName,
		cont_position_name AS contPositionName,
		cont_emp_name AS contEmpName,
		cont_client_company AS contClientCompany,
		cont_client_ceo_name AS contClientCeoName,
		cont_client_responsibility 	AS contClientResponsibility,
		cont_client_res_cp 	AS contClientResCp,
		cont_client_res_email AS contClientResEmail,
		cont_orderDate 	AS contOrderDate,
		cont_dueDate AS contDueDate,
		cont_note AS contNote,
		client_license_num_fk AS clientLicenseNumFk
		FROM contract 
		<include refid="searchCondition"></include> 
		ORDER BY contID DESC
	</select>
	
	<delete id="setContDel" parameterType="int">
		DELETE FROM contract WHERE cont_id = #{contID}
	</delete>
	
	<select id="getcontDocNum" resultType="String" parameterType="int">
		SELECT cont_doc_num AS contDocNum FROM contract WHERE cont_id = #{contID}
	</select>
	
	<insert id="setContD" parameterType="contractvo">
		INSERT INTO contract_detail SET 
		contD_doc_num_fk = #{contDocNum},
		contD_p_name = #{contDpName},
		contD_p_unit = #{contDpUnit},
		contD_p_amount = #{contDpAmount},
		contD_p_sell = #{contDpSell},
		contD_vat = #{contDVat}
	</insert>
	
	<select id="getContDList" resultType="contractvo" parameterType="String">
		SELECT 
		contD_id AS contDID,
		contD_doc_num_fk AS contDdocNumFk,
		contD_p_name AS contDpName,
		contD_p_unit AS contDpUnit,
		contD_p_amount AS contDpAmount,
		contD_p_sell AS contDpSell,
		contD_vat AS contDVat,
		p_buy AS pBuy,
		p_size AS pSize,
		p_code AS pCode 
		FROM contract_detail 
		LEFT JOIN product ON p_name = contD_p_name 
		WHERE contD_doc_num_fk = #{contDocNum}
	</select>
	
	<delete id="setContDDel" parameterType="int">
		DELETE FROM contract_detail WHERE contD_id = #{setContDDel}
	</delete>
	
	<select id="getcontDMOne" resultType="contractvo" parameterType="String">
		SELECT
		cont_id AS contID,
		cont_doc_num AS contDocNum,
		cont_com_name AS contComName,
		cont_emp_company AS contEmpCompany,
		cont_depart_name AS contDepartName,
		cont_position_name AS contPositionName,
		cont_emp_name AS contEmpName,
		cont_client_company AS contClientCompany,
		cont_client_ceo_name AS contClientCeoName,
		cont_client_responsibility 	AS contClientResponsibility,
		cont_client_res_cp 	AS contClientResCp,
		cont_client_res_email AS contClientResEmail,
		cont_orderDate 	AS contOrderDate,
		cont_dueDate AS contDueDate,
		cont_note AS contNote,
		client_license_num_fk AS clientLicenseNumFk
		FROM contract 
		WHERE cont_doc_num = #{contDocNum}
	</select>
	
	<update id="setContDModUp" parameterType="contractvo">
		UPDATE contract SET 
			cont_doc_num = #{contDocNum},
			cont_com_name = #{contComName},
			cont_emp_company = #{contEmpCompany},
			cont_depart_name = #{contDepartName},
			cont_position_name = #{contPositionName},
			cont_emp_name = #{contEmpName},
			cont_client_company = #{contClientCompany},
			cont_client_ceo_name = #{contClientCeoName},
			cont_client_responsibility 	= #{contClientResponsibility},
			cont_client_res_cp 	= #{contClientResCp},
			cont_client_res_email = #{contClientResEmail},
			cont_orderDate 	= #{contOrderDate},
			cont_dueDate = #{contDueDate},
			cont_note = #{contNote},
			client_license_num_fk = #{clientLicenseNumFk}
		WHERE cont_id = #{contID}
	</update>
	
	<select id="countC" resultType="int">
		SELECT COUNT(*) FROM contract
	</select>
	
	<select id="countCD" resultType="int" parameterType="String">
		SELECT COUNT(*) FROM contract_detail WHERE contD_doc_num_fk = #{contDocNum} 
	</select>
</mapper>